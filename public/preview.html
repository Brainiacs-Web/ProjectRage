<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>PWians Admin - Test Preview</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
:root {
  --primary: #667eea;
  --primary-dark: #5a67d8;
  --secondary: #764ba2;
  --accent: #f093fb;
  --success: #48bb78;
  --warning: #ed8936;
  --error: #f56565;
  --info: #4299e1;
  
  --bg-primary: #f7fafc;
  --bg-secondary: #ffffff;
  --bg-tertiary: #edf2f7;
  --bg-glass: rgba(255, 255, 255, 0.25);
  
  --text-primary: #2d3748;
  --text-secondary: #4a5568;
  --text-muted: #718096;
  --text-inverse: #ffffff;
  
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --bg-glass: rgba(30, 41, 59, 0.8);
  
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  
  --border: #334155;
  --border-light: #475569;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  font-size: 14px;
  overflow-x: hidden;
  transition: var(--transition);
}

/* Glassmorphism utility */
.glass {
  background: var(--bg-glass);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Modern scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 24px 32px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  opacity: 0.3;
}

.header-content {
  position: relative;
  z-index: 2;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.header-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.header-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-details {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.header-detail {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  background: rgba(255, 255, 255, 0.1);
  padding: 8px 16px;
  border-radius: var(--radius-lg);
  backdrop-filter: blur(10px);
}

.header-actions {
  display: flex;
  gap: 12px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  white-space: nowrap;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: var(--transition);
}

.btn:hover::before {
  left: 100%;
}

.btn-glass {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
}

.btn-glass:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.theme-toggle {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.theme-toggle:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.05);
}

/* Subject Tabs */
.subject-tabs {
  background: var(--bg-secondary);
  padding: 24px 32px;
  border-bottom: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
}

.subject-tabs-container {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding: 4px 0;
}

.subject-tab {
  flex: 0 0 auto;
  padding: 12px 24px;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
}

.subject-tab:hover {
  background: rgba(102, 126, 234, 0.1);
  border-color: var(--primary);
  color: var(--primary);
}

.subject-tab.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: var(--primary);
  box-shadow: var(--shadow-md);
}

/* Main Layout */
.main-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 24px;
  padding: 32px;
  max-width: 1400px;
  margin: 0 auto;
  min-height: calc(100vh - 200px);
}

/* Sidebar */
.sidebar {
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-light);
  overflow: hidden;
  height: fit-content;
  max-height: calc(100vh - 250px);
  position: sticky;
  top: 32px;
}

.sidebar-header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 20px 24px;
  font-weight: 700;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.sidebar-content {
  padding: 16px 0;
  max-height: calc(100vh - 350px);
  overflow-y: auto;
}

.question-list {
  list-style: none;
}

.question-item {
  padding: 16px 24px;
  cursor: pointer;
  transition: var(--transition);
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
}

.question-item:hover {
  background: rgba(102, 126, 234, 0.1);
  color: var(--primary);
}

.question-item.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  position: relative;
}

.question-item.active::after {
  content: '';
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 24px;
  background: white;
  border-radius: 2px 0 0 2px;
}

.question-number {
  width: 32px;
  height: 32px;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 12px;
  color: var(--primary);
}

.question-item.active .question-number {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

/* Main Content */
.main-content {
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-light);
  overflow: hidden;
  animation: slideUp 0.6s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.content-header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 24px 32px;
  position: relative;
  overflow: hidden;
}

.content-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: rotate 20s linear infinite;
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.content-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  z-index: 2;
}

.content-body {
  padding: 32px;
}

/* Question Card */
.question-card {
  background: var(--bg-tertiary);
  border: 2px solid var(--border-light);
  border-radius: var(--radius-xl);
  padding: 32px;
  margin-bottom: 24px;
  position: relative;
  transition: var(--transition);
}

.question-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.question-text {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 24px;
  line-height: 1.6;
}

.question-meta {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

.meta-item i {
  color: var(--primary);
}

/* Options */
.options-container {
  margin: 24px 0;
}

.options-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.options-list {
  list-style: none;
  display: grid;
  gap: 12px;
}

.option-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  transition: var(--transition);
  font-weight: 500;
}

.option-item:hover {
  border-color: var(--primary);
  background: rgba(102, 126, 234, 0.05);
}

.option-item.correct {
  border-color: var(--success);
  background: rgba(72, 187, 120, 0.1);
  color: var(--success);
}

.option-label {
  width: 32px;
  height: 32px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
}

.option-item.correct .option-label {
  background: var(--success);
}

/* Answer Section */
.answer-section {
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin: 24px 0;
}

.answer-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--success);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.answer-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}

/* Solution Section */
.solution-section {
  background: rgba(102, 126, 234, 0.05);
  border: 2px solid rgba(102, 126, 234, 0.2);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin: 24px 0;
}

.solution-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.solution-text {
  font-size: 16px;
  line-height: 1.6;
  color: var(--text-primary);
}

/* Edit Mode */
.edit-form {
  display: grid;
  gap: 24px;
}

.form-group {
  position: relative;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-label i {
  color: var(--primary);
  font-size: 16px;
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 16px 20px;
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-family: inherit;
  background: var(--bg-secondary);
  color: var(--text-primary);
  transition: var(--transition);
  outline: none;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  transform: translateY(-2px);
}

.form-textarea {
  resize: vertical;
  min-height: 120px;
  font-family: inherit;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
  flex-wrap: wrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-2px);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #38a169);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-danger {
  background: linear-gradient(135deg, var(--error), #e53e3e);
  color: white;
  box-shadow: var(--shadow-md);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Navigation */
.navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 32px;
  background: var(--bg-tertiary);
  border-top: 1px solid var(--border-light);
}

.nav-info {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
}

.nav-buttons {
  display: flex;
  gap: 12px;
}

/* Loading States */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 24px;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 16px;
}

/* Toast Notifications */
.toast {
  position: fixed;
  top: 24px;
  right: 24px;
  padding: 16px 24px;
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 600;
  z-index: 2000;
  box-shadow: var(--shadow-lg);
  transform: translateX(100%);
  transition: var(--transition);
  max-width: 400px;
  display: flex;
  align-items: center;
  gap: 12px;
  backdrop-filter: blur(20px);
}

.toast.show {
  transform: translateX(0);
}

.toast-success {
  background: linear-gradient(135deg, var(--success), #38a169);
  color: white;
}

.toast-error {
  background: linear-gradient(135deg, var(--error), #e53e3e);
  color: white;
}

.toast-info {
  background: linear-gradient(135deg, var(--info), #3182ce);
  color: white;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .main-layout {
    grid-template-columns: 1fr;
    gap: 16px;
    padding: 20px;
  }
  
  .sidebar {
    position: static;
    max-height: 300px;
  }
  
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-details {
    gap: 12px;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 20px;
  }
  
  .subject-tabs {
    padding: 16px 20px;
  }
  
  .content-body {
    padding: 20px;
  }
  
  .question-card {
    padding: 20px;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .action-buttons .btn {
    width: 100%;
  }
  
  .navigation {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
}

/* Focus styles */
button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="header-title">
          <i class="fas fa-clipboard-list"></i>
          <span id="test-name">Loading...</span>
        </h1>
        <div class="header-details">
          <div class="header-detail">
            <i class="fas fa-book"></i>
            <span>Subject: <span id="current-subject">Loading...</span></span>
          </div>
          <div class="header-detail">
            <i class="fas fa-list-ol"></i>
            <span>Question: <span id="current-question-index">0</span>/<span id="total-questions">0</span></span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-glass" onclick="loadQuestions()">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </button>
        <button class="theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Subject Tabs -->
  <section class="subject-tabs">
    <div class="subject-tabs-container" id="subject-buttons">
      <!-- Subject tabs will be populated here -->
    </div>
  </section>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-list"></i>
        Questions
      </div>
      <div class="sidebar-content">
        <ul class="question-list" id="question-list">
          <!-- Questions will be populated here -->
        </ul>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="content-header">
        <h2 class="content-title">
          <i class="fas fa-question-circle"></i>
          Question Preview
        </h2>
      </div>
      <div class="content-body">
        <div id="question-content">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading question...</div>
          </div>
        </div>
      </div>
      <div class="navigation">
        <div class="nav-info">
          Navigate through questions using the sidebar or buttons below
        </div>
        <div class="nav-buttons">
          <button class="btn btn-secondary" onclick="prevQuestion()" id="prevBtn">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button class="btn btn-secondary" onclick="nextQuestion()" id="nextBtn">
            <i class="fas fa-chevron-right"></i>
            Next
          </button>
        </div>
      </div>
    </main>
  </div>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
  // ─────────────────────────────────────────────────────────────────────────────
  // 1. Dark mode functionality
  // ─────────────────────────────────────────────────────────────────────────────
  let isDarkMode = localStorage.getItem('darkMode') === 'true';
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;

  function initializeDarkMode() {
    if (isDarkMode) {
      body.classList.add('dark-mode');
      themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
      body.classList.remove('dark-mode');
      themeToggle.querySelector('i').className = 'fas fa-moon';
    }
  }

  function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    body.classList.toggle('dark-mode', isDarkMode);
    localStorage.setItem('darkMode', isDarkMode);
    
    const icon = themeToggle.querySelector('i');
    icon.style.transform = 'rotate(180deg) scale(0.8)';
    setTimeout(() => {
      icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
      icon.style.transform = 'rotate(0deg) scale(1)';
    }, 150);
  }

  themeToggle.addEventListener('click', toggleDarkMode);
  initializeDarkMode();

  // ─────────────────────────────────────────────────────────────────────────────
  // 2. Utility functions for text formatting
  // ─────────────────────────────────────────────────────────────────────────────
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name) || '';
  }

  // 2a. LaTeX Rendering Helper
  function renderLatex(str) {
    if (!str) return "—";

    const alreadyHasDelimiters =
         /\\\(.+?\\\)/.test(str)    
      || /\\\[.+?\\\]/.test(str)    
      || /\$\$[\s\S]+?\$\$/.test(str)
      || /\\begin\{.+?\}[\s\S]+?\\end\{.+?\}/.test(str);

    if (alreadyHasDelimiters) {
      return str;
    }

    const hasInlineMath =
         /\\frac\s*{[^}]+}\s*{[^}]+}/.test(str)
      || /\\hat\{[^}]+\}/.test(str)
      || /\\pi\b/.test(str)
      || /\\varepsilon/.test(str)
      || /[A-Za-z]+_\{.+?\}/.test(str);

    if (hasInlineMath) {
      return `\\(${str}\\)`;
    }

    return str;
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 2b. Convert any image-URL inside a DOM subtree into a real <img> element
  // ─────────────────────────────────────────────────────────────────────────────
  function convertUrlsToImages(root) {
    const imageUrlRegex = /(https?:\/\/[^\s"'<>]+?\.(png|jpe?g|gif|svg)(\?[^"\s<>]*)?)/gi;

    root.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const textContent = node.textContent;
        const replacedHTML = textContent.replace(imageUrlRegex, match => {
          return `<img src="${match}" class="question-image" alt="Embedded image">`;
        });

        if (replacedHTML !== textContent) {
          const wrapper = document.createElement('span');
          wrapper.innerHTML = replacedHTML;
          node.replaceWith(wrapper);
        }
      }
      else if (node.nodeType === Node.ELEMENT_NODE) {
        convertUrlsToImages(node);
      }
      // ignore other node types
    });
  }

  function showError(message) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('results-content').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('error-message').textContent = message;
  }

  function showResults() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('results-content').style.display = 'block';
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 3. Get URL parameters
  // ─────────────────────────────────────────────────────────────────────────────
  const testID    = getParam('test');
  const batchName = getParam('batch');
  const username  = getParam('username');

  if (!testID || !batchName || !username) {
    showError('Missing required parameters. Please check the URL and try again.');
    throw new Error('Missing URL parameters');
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 4. Global state for results
  // ─────────────────────────────────────────────────────────────────────────────
  let resultsData = null;
  let currentSubject = '';
  let currentQuestionIndex = 0;
  let currentSubjectQuestions = [];

  // ─────────────────────────────────────────────────────────────────────────────
  // 5. API helper
  // ─────────────────────────────────────────────────────────────────────────────
  async function api(path, opts = {}) {
    try {
      const response = await fetch('/api/' + path, {
        headers: { 'Content-Type': 'application/json' },
        ...opts
      });
      if (!response.ok) {
        const errorBody = await response.json().catch(() => ({}));
        throw new Error(errorBody.error || `API Error: ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 6. Fetch results from backend
  // ─────────────────────────────────────────────────────────────────────────────
  async function fetchResults() {
    try {
      const response = await fetch(
        `/api/tests/${encodeURIComponent(testID)}/results` +
        `?batchName=${encodeURIComponent(batchName)}` +
        `&username=${encodeURIComponent(username)}`
      );

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || 'Failed to load results');
      }
      return await response.json();
    } catch (error) {
      console.error('Fetch error:', error);
      throw error;
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 7. Create doughnut chart
  // ─────────────────────────────────────────────────────────────────────────────
  function createDoughnutChart(ctx, data) {
    return new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Correct', 'Wrong', 'Unanswered'],
        datasets: [{
          data: data,
          backgroundColor: ['#10B981', '#EF4444', '#F59E0B'],
          borderWidth: 0,
          cutout: '70%'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true
          }
        }
      }
    });
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 8. Render statistics cards with new marking scheme
  // ─────────────────────────────────────────────────────────────────────────────
  function renderStats(totalCorrect, totalWrong, totalUnanswered, totalScore) {
    const statsGrid = document.getElementById('stats-grid');
    statsGrid.innerHTML = `
      <div class="stat-card correct">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-number">${totalCorrect}</div>
        <div class="stat-label">Correct</div>
      </div>
      <div class="stat-card wrong">
        <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
        <div class="stat-number">${totalWrong}</div>
        <div class="stat-label">Wrong</div>
      </div>
      <div class="stat-card unanswered">
        <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
        <div class="stat-number">${totalUnanswered}</div>
        <div class="stat-label">Unanswered</div>
      </div>
      <div class="stat-card score">
        <div class="stat-icon"><i class="fas fa-trophy"></i></div>
        <div class="stat-number">${totalScore}</div>
        <div class="stat-label">Total Score</div>
      </div>
    `;
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 9. Render subject tabs
  // ─────────────────────────────────────────────────────────────────────────────
  function renderSubjectTabs(subjects) {
    const tabsContainer = document.getElementById('subject-tabs');
    tabsContainer.innerHTML = '';

    subjects.forEach((subject, index) => {
      const tab = document.createElement('button');
      tab.className = 'subject-tab';
      tab.innerHTML = `
        <i class="fas fa-book"></i>
        <span>${subject}</span>
      `;
      tab.onclick = () => selectSubject(subject, index);
      tabsContainer.appendChild(tab);
    });
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 10. Select subject and show questions
  // ─────────────────────────────────────────────────────────────────────────────
  function selectSubject(subject, index) {
    currentSubject = subject;
    currentSubjectQuestions = resultsData.results[subject] || [];
    currentQuestionIndex = 0;

    document.querySelectorAll('.subject-tab').forEach((tab, i) => {
      tab.classList.toggle('active', i === index);
    });

    renderQuestion();
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 11. Render current question (with URL→<img> conversion)
  // ─────────────────────────────────────────────────────────────────────────────
  function renderQuestion() {
    const questionsContent = document.getElementById('questions-content');
    const questionCounter   = document.getElementById('question-counter');

    if (!currentSubjectQuestions.length) {
      questionsContent.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-inbox"></i></div>
          <h3 class="empty-title">No Questions Found</h3>
          <p class="empty-text">No questions available for this subject</p>
        </div>
      `;
      return;
    }

    const question = currentSubjectQuestions[currentQuestionIndex];
    const selectedAnswer = (question.selectedAnswer || '').trim().toUpperCase();
    const correctAnswer  = (question.correctAnswer  || '').trim().toUpperCase();
    const isCorrect = selectedAnswer === correctAnswer;
    const isAnswered = selectedAnswer !== '';

    questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${currentSubjectQuestions.length}`;

    let status = 'unanswered';
    if (isAnswered) {
      status = isCorrect ? 'correct' : 'wrong';
    }

    let optionsHTML = '';
    if (question.options && question.options.length) {
      optionsHTML = `
        <ul class="options-list">
          ${question.options.map(option => {
            const optionText = renderLatex(option);
            const optionUpper = option.trim().toUpperCase();
            let classes = 'option-item';
            if (optionUpper === correctAnswer) classes += ' correct';
            if (optionUpper === selectedAnswer && !isCorrect) classes += ' selected';
            return `<li class="${classes}">${optionText}</li>`;
          }).join('')}
        </ul>
      `;
    }

    let answerSummaryHTML = '';
    if (isAnswered) {
      answerSummaryHTML = `
        <div class="answer-summary">
          <div class="answer-item your-answer ${isCorrect ? 'correct' : ''}">
            <strong>Your Answer:</strong> ${selectedAnswer}
          </div>
          ${!isCorrect ? `
            <div class="answer-item correct-answer">
              <strong>Correct Answer:</strong> ${correctAnswer}
            </div>
          ` : ''}
        </div>
      `;
    } else {
      answerSummaryHTML = `
        <div class="answer-summary">
          <div class="answer-item your-answer">
            <strong>Your Answer:</strong> Not answered
          </div>
          <div class="answer-item correct-answer">
            <strong>Correct Answer:</strong> ${correctAnswer}
          </div>
        </div>
      `;
    }

    questionsContent.innerHTML = `
      <div class="question-card">
        <div class="question-header">
          <div class="question-number">Question ${currentQuestionIndex + 1}</div>
          <div class="question-status ${status}">
            <i class="fas fa-${status === 'correct' ? 'check' : status === 'wrong' ? 'times' : 'question'}"></i>
            ${status.charAt(0).toUpperCase() + status.slice(1)}
          </div>
        </div>
        <div class="question-body">
          <div class="question-text">
            ${renderLatex(question.question)}
          </div>
          
          ${optionsHTML}
          
          ${answerSummaryHTML}
          
          <div class="solution-section">
            <div class="solution-title">
              <i class="fas fa-lightbulb"></i>
              Solution
            </div>
            <div class="solution-text">
              ${renderLatex(question.solution || 'No solution provided.')}
            </div>
          </div>
          
          <div class="question-nav">
            <button
              class="nav-btn secondary"
              onclick="previousQuestion()"
              ${currentQuestionIndex === 0 ? 'disabled' : ''}
            >
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button
              class="nav-btn primary"
              onclick="nextQuestion()"
              ${currentQuestionIndex === currentSubjectQuestions.length - 1 ? 'disabled' : ''}
            >
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    `;

    // ── Key step: convert **any** image URL in the newly injected HTML into <img> tags ──
    convertUrlsToImages(questionsContent);

    // Trigger MathJax to typeset LaTeX
    if (window.MathJax) {
      MathJax.typesetPromise([questionsContent]).catch(err => console.error("MathJax error:", err));
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 12. Navigation functions
  // ─────────────────────────────────────────────────────────────────────────────
  function previousQuestion() {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderQuestion();
    }
  }

  function nextQuestion() {
    if (currentQuestionIndex < currentSubjectQuestions.length - 1) {
      currentQuestionIndex++;
      renderQuestion();
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 13. Main function to display results with new marking scheme
  // ─────────────────────────────────────────────────────────────────────────────
  async function displayResults() {
    try {
      resultsData = await fetchResults();
      const { testName, subjects, results } = resultsData;

      let totalCorrect = 0, totalWrong = 0, totalUnanswered = 0, totalScore = 0;
      Object.entries(results).forEach(([subject, questions]) => {
        questions.forEach(question => {
          const selected = (question.selectedAnswer || '').trim().toUpperCase();
          const correct  = (question.correctAnswer  || '').trim().toUpperCase();
          if (!selected) {
            totalUnanswered++;
          } else if (selected === correct) {
            totalCorrect++;
            totalScore += 4;
          } else {
            totalWrong++;
            totalScore -= 1;
          }
        });
      });

      renderStats(totalCorrect, totalWrong, totalUnanswered, totalScore);

      const chartCtx = document.getElementById('overview-chart').getContext('2d');
      createDoughnutChart(chartCtx, [totalCorrect, totalWrong, totalUnanswered]);

      renderSubjectTabs(subjects);
      if (subjects.length > 0) selectSubject(subjects[0], 0);
      showResults();
    } catch (error) {
      console.error('Error displaying results:', error);
      showError(error.message || 'Failed to load results. Please try again.');
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 14. Keyboard navigation
  // ─────────────────────────────────────────────────────────────────────────────
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      previousQuestion();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      nextQuestion();
    }
  });

  // ─────────────────────────────────────────────────────────────────────────────
  // 15. Initialize on window load
  // ─────────────────────────────────────────────────────────────────────────────
  window.addEventListener('load', displayResults);
  window.previousQuestion = previousQuestion;
  window.nextQuestion     = nextQuestion;
</script>


</body>
</html>
